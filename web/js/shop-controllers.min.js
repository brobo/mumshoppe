var app = angular.module('mumshoppe-shop', [
	'angular-jwt',
	'ui.router',
	'ui.bootstrap',
	'ajoslin.promise-tracker',
	'ngCookies',
	'ngMessages',
	'shared.partials',
	'shop.partials',
	'controller.alerts',
	'controller.really',
	'shop.controller.login',
	'shop.controller.home',
	'shop.controller.customize',
	'shop.controller.backings',
	'shop.controller.accent-bows',
	'shop.controller.ribbons',
	'shop.controller.accessories',
	'shop.controller.bears',
	'shop.controller.review',
	'shop.controller.pay',
	'service.alert',
	'service.customer',
	'service.accent-bow',
	'service.backing',
	'service.really',
	'service.group',
	'service.letter',
	'service.ribbon',
	'service.bear',
	'service.accessory',
	'service.category',
	'service.accessory-association',
	'service.mum',
	'service.product',
	'service.order'
]);

app.config([
'$stateProvider',
'$urlRouterProvider',
'$httpProvider',
function($stateProvider, $urlRouterProvider, $httpProvider) {

	$stateProvider
		.state('index', {
			url: ''
		})
		.state('login', {
			url: '/login',
			templateUrl: 'login.html',
			controller: 'LoginController'
		})
		.state('base', {
			templateUrl: 'base.html'
		})
		.state('base.home', {
			url: '/home',
			templateUrl: 'home.html',
			controller: 'HomeController'
		})
		.state('base.customize', {
			url: '/customize/:order_id',
			templateUrl: 'customize.html',
			controller: 'CustomizeController'
		})
		.state('base.customize.backings', {
			url: '/backings',
			parent: 'base.customize',
			templateUrl: 'customize/backings.html',
			controller: 'BackingsController'
		})
		.state('base.customize.accentbows', {
			url: '/accentbows',
			parent: 'base.customize',
			templateUrl: 'customize/accent-bows.html',
			controller: 'AccentBowsController'
		})
		.state('base.customize.ribbons', {
			url: '/ribbons',
			parent: 'base.customize',
			templateUrl: 'customize/ribbons.html',
			controller: 'RibbonsController'
		})
		.state('base.customize.bears', {
			url: '/bears',
			parent: 'base.customize',
			templateUrl: 'customize/bears.html',
			controller: 'BearsController'
		})
		.state('base.customize.accessories', {
			url: '/accessories',
			parent: 'base.customize',
			templateUrl: 'customize/accessories.html',
			controller: 'AccessoriesController'
		})
		.state('base.customize.review', {
			url: '/review',
			parent: 'base.customize',
			templateUrl: 'customize/review.html',
			controller: 'ReviewController'
		})
		.state('base.pay', {
			url: '/pay/:orderId',
			templateUrl: 'pay.html',
			controller: 'PayController'
		})

		$httpProvider.defaults.post = {'Content-Type': 'application/x-www-form-urlencoded'};
		$httpProvider.defaults.put = {'Content-Type': 'application/x-www-form-urlencoded'};

}]);

angular.module('controller.alerts', [])
.controller('AlertsController', ['$scope', 'AlertService', function($scope, AlertService) {
	$scope.closeAlert = AlertService.close;
}]);
angular.module('controller.really', [])
.controller('ReallyController', [
'$scope',
'$modalInstance',
'promiseTracker',
'data',
'callback',
function($scope, $modalInstance, promiseTracker, data, callback) {

	$scope.data = data;
	$scope.cancel = $modalInstance.dismiss;
	$scope.tracker = promiseTracker();

	$scope.confirm = function() {
		var promise = callback();
		if (promise.then) {
			var deferred = $scope.tracker.createPromise();
			promise.then($modalInstance.close, $modalInstance.dismiss).finally(deferred.resolve);
		} else {
			$modalInstance.close();
		}
	}
}]);
angular.module('shop.controller.accent-bows', [])
.controller('AccentBowsController', [
'$scope',
'promiseTracker',
'AlertService',
'AccentBowService',
function($scope, promiseTracker, AlertService, AccentBowService) {

	$scope.bows = [];

	$scope.mumPromise
	.then(AccentBowService.findAll)
	.then(function(data) {
		$scope.bows = data;
		for (var i = 0; i < $scope.bows.length; i++) {
			$scope.bows[i].tracker = promiseTracker();
			$scope.bows[i].imageUrl = AccentBowService.imageUrl($scope.bows[i].id);
		}
	}, function() {
		AlertService.add('danger', 'Unable to load bows.');
	});

	$scope.select = function(bow) {
		var target = angular.copy($scope.mum);
		target.accentBow = bow;
		var deferred = bow.tracker.createPromise();

		$scope.save(target).finally(deferred.resolve);
	}
}]);

angular.module('shop.controller.accessories', [])
.controller('AccessoriesController', [
'$scope',
'$modal',
'promiseTracker',
'AlertService',
'AccessoryService',
'AccessoryAssociationService',
'CategoryService',
function($scope, $modal, promiseTracker, AlertService, AccessoryService, AccessoryAssociationService, CategoryService) {

	$scope.categories = [];
	$scope.accessories = [];
	$scope.associations = {};

	CategoryService.findAll().then(function(data) {
		$scope.categories = data;
	}, function() {
		AlertService.add('danger', 'Unable to load categories.');
	});

	$scope.mumPromise.then(function() {
		for (var i = 0; i < $scope.mum.associations.length; i++) {
			$scope.associations[$scope.mum.associations[i].accessory.id] = $scope.mum.associations[i];
		}
	}).then(AccessoryService.findAll).then(function(data) {
		$scope.accessories = data;
		for (var i = 0; i < $scope.accessories.length; i++) {
			$scope.accessories[i].imageUrl = AccessoryService.imageUrl($scope.accessories[i].id);
			$scope.accessories[i].tracker = promiseTracker();
		}
		console.log($scope.associations);
	});

	$scope.hasAccessory = function(accessory) {
		return (accessory.id in $scope.associations);
	}

	$scope.filterAccessories = function(group) {
		return function(accessory) {
			if ($scope.selectedCategory && 
				accessory.category && 
				accessory.category.id != $scope.selectedCategory) {
				return false;
			}
			for (var i = 0; i < accessory.groups.length; i++) {
				if (accessory.groups[i].id == group.id) {
					return true;
				}
			}
			return false;
		}
	}

	$scope.addAssociation = function(accessory) {
		$modal.open({
			size: 'sm',
			templateUrl: 'edit-association.html',
			controller: 'EditQuantityController',
			resolve: {
				association: function() {
					return {
						mum: $scope.mum,
						accessory: accessory,
						quantity: 1
					};
				},
				callback: function() {
					return function(association) {
						return AccessoryAssociationService.create(association).then(function(data) {
							$scope.associations[data.accessory.id] = data;
						});
					};
				}
			}
		});
	}

	$scope.editAssociation = function(accessory) {
		$modal.open({
			size: 'sm',
			templateUrl: 'edit-association.html',
			controller: 'EditQuantityController',
			resolve: {
				association: function() {
					var target = angular.copy($scope.associations[accessory.id]);
					target.mum = $scope.mum;
					return target;
				},
				callback: function() {
					return function(association) {
						return AccessoryAssociationService.update(association.id, association).then(function(data) {
							$scope.associations[data.accessory.id] = data;
						});
					};
				}
			}
		});
	}
	
	$scope.removeAssociation = function(accessory) {
		var deferred = accessory.tracker.createPromise();
		AccessoryAssociationService.delete($scope.associations[accessory.id].id).then(function() {
			delete $scope.associations[accessory.id];
		}, function() {
			AlertService.add('danger', 'An error occured while remove the accessory.');
		}).finally(deferred.resolve);
	}

}])
.controller('EditQuantityController', [
'$scope',
'$modalInstance',
'AlertService',
'promiseTracker',
'callback',
'association',
function($scope, $modalInstance, AlertService, promiseTracker, callback, association) {

	$scope.association = association;
	$scope.accessory = association.accessory;
	$scope.tracker = promiseTracker();
	$scope.cancel = $modalInstance.dismiss;

	$scope.increase = function() {
		$scope.association.quantity++;
	}

	$scope.decrease = function() {
		if ($scope.association.quantity > 1) {
			$scope.association.quantity--;
		}
	}

	$scope.save = function() {
		var deferred = $scope.tracker.createPromise();
		var target = angular.copy($scope.association);
		target.mum = target.mum.id;
		target.accessory = target.accessory.id;
		callback(target).then($modalInstance.close.bind(null, $scope.association), function() {
			AlertService.add('danger', 'Unable to save accessory.');
			$modalInstance.dismiss();
		}).finally(deferred);
	}

}]);

angular.module('shop.controller.backings', [])
.controller('BackingsController', [
'$scope',
'promiseTracker',
'AlertService',
'BackingService',
function($scope, promiseTracker, AlertService, BackingService) {

	$scope.backings = [];

	$scope.mumPromise
	.then(BackingService.findAll)
	.then(function(data) {
		$scope.backings = data;
		for (var i = 0; i < $scope.backings.length; i++) {
			$scope.backings[i].tracker = promiseTracker();
			$scope.backings[i].imageUrl = BackingService.imageUrl($scope.backings[i].id);
		}
	}, function() {
		AlertService.add('danger', 'Unable to load backings.');
	});

	$scope.select = function(backing) {
		var target = angular.copy($scope.mum);
		target.backing = backing;
		var deferred = backing.tracker.createPromise();

		$scope.save(target).finally(deferred.resolve);
	}


}]);

angular.module('shop.controller.bears', [])
.controller('BearsController', [
'$scope',
'promiseTracker',
'AlertService',
'BearService',
function($scope, promiseTracker, AlertService, BearService) {

	$scope.bears = [];

	$scope.mumPromise.then(BearService.findAll).then(function(data) {
		$scope.bears = data;
		for (var i = 0; i < $scope.bears.length; i++) {
			$scope.bears[i].tracker = promiseTracker();
			$scope.bears[i].imageUrl = BearService.imageUrl($scope.bears[i].id);
		}
	});

	$scope.hasGroup = function(group) {
		return function(bear) {
			for (var i = 0; i < bear.groups.length; i++) {
				if (bear.groups[i].id == group.id) {
					return true;
				}
			}
			return false;
		}
	}

	$scope.hasBear = function(bear) {
		for (var i = 0; i < $scope.mum.bears.length; i++) {
			if ($scope.mum.bears[i].id == bear.id) {
				return true;
			}
		}
		return false;
	}

	$scope.addBear = function(bear) {
		var deferred = bear.tracker.createPromise();

		if ($scope.mum.bears.length >= $scope.mum.backing.product.bearLimit) return;
		var target = angular.copy($scope.mum);
		for (var i = 0; i < target.bears.length; i++) {
			target.bears[i] = target.bears[i].id;
		}
		target.bears.push(bear.id);

		$scope.save(target).finally(deferred.resolve);
	}
	
	$scope.removeBear = function(bear) {
		var deferred = bear.tracker.createPromise();

		var target = angular.copy($scope.mum);
		for (var i = 0; i < target.bears.length; i++) {
			if (target.bears[i].id == bear.id) {
				target.bears.splice(i, 1);
				i--;
			} else {
				target.bears[i] = target.bears[i].id;
			}
		}

		$scope.save(target).finally(deferred.resolve);
	}

}]);

angular.module('shop.controller.customize', [])
.controller('CustomizeController', [
'$scope',
'$stateParams',
'promiseTracker',
'AlertService',
'MumService',
'OrderService',
function($scope, $stateParams, promiseTracker, AlertService, MumService, OrderService) {

	$scope.order_id = $stateParams.order_id;
	$scope.order = {};
	$scope.mum = {};

	$scope.mumTracker = promiseTracker();
	var deferred = $scope.mumTracker.createPromise();

	$scope.mumPromise = OrderService.findById($scope.order_id).then(function(data) {
		$scope.order = data;
		$scope.mum = data.mum;
		deferred.resolve();
	}, function() {
		AlertService.add('danger', 'Unable to load the order.');
	});

	$scope.save = function(mum) {
		var target = angular.copy(mum);

		if (target.backing) target.backing = target.backing.id;
		if (target.accentBow) target.accentBow = target.accentBow.id;
		if (target.ribbons) {
			for (var i = 0; i < target.ribbons.length; i++) {
				target.ribbons[i].letter = target.ribbons[i].letter.id;
			}
		}
		return MumService.update($scope.mum.id, target).then(function(data) {
			console.log(data);
			$scope.mum = data;
		}, function() {
			AlertService.add('danger', 'Unable to save the mum.');
		});
	};

}]);

angular.module('shop.controller.home', [])
.controller('HomeController', [
'$scope',
'$modal',
'$q',
'AlertService',
'GroupService',
'ProductService',
'BackingService',
'MumService',
function($scope, $modal, $q, AlertService, GroupService, ProductService, BackingService, MumService) {

	$scope.groups = [];
	$scope.products = [];
	$scope.backings = [];

	$q.all([
		GroupService.findAll().then(function(data) {
			$scope.groups = data;
		}),
		ProductService.findAll().then(function(data) {
			$scope.products = data;
		}),
		BackingService.findAll().then(function(data) {
			$scope.backings = data;
			for (var i = 0; i < $scope.backings.length; i++) {
				$scope.backings[i].imageUrl = BackingService.imageUrl($scope.backings[i].id);
			}

		})
	]).catch(function() {
		AlertService.add('danger', 'Failed to load mum creation data. Please refresh and try again.');
	});

	function updateMums() {
		MumService.findAll().then(function(data) {
			$scope.mums = data;
		}, function() {
			AlertService.add('danger', 'Failed to load mums.');
		});
	}
	updateMums();
	

	$scope.createMum = function() {
		return $modal.open({
			size: 'large',
			templateUrl: 'createMum.html',
			controller: 'home.CreateController',
			resolve: {
				groups: function() { return $scope.groups; },
				products: function() { return $scope.products; },
				backings: function() { return $scope.backings; }
			}
		});
	};

}])
.controller('home.CreateController', [
'$scope',
'$cookies',
'$modalInstance',
'jwtHelper',
'promiseTracker',
'MumService',
'OrderService',
'groups',
'products',
'backings',
function($scope, $cookies, $modalInstance, jwtHelper, promiseTracker, MumService, OrderService, groups, products, backings) {

	$scope.groups = groups;
	$scope.products = products;
	$scope.backings = backings;

	for (var i = 0; i < $scope.backings.length; i++) {
		$scope.backings[i].tracker = promiseTracker();
	}

	$scope.create = function(backing) {
		var deferred = backing.tracker.createPromise();
		MumService.create({
			backing: backing.id
		})
		.then(function(data) {
			var customerId = jwtHelper.decodeToken($cookies.get('jwt')).user_id;
			return OrderService.create(customerId, data.id);
		})
		.then(function(data) {
			$state.go('base.customize', {order_id: data.id});
		}, function(error) {
			console.error(error);
		}).finally(deferred.resolve);
	}

}]);

angular.module('shop.controller.login', [])
.controller('LoginController', [
'$scope',
'$cookies',
'$state',
'jwtHelper',
'promiseTracker',
'AlertService',
'CustomerService',
function($scope, $cookies, $state, jwtHelper, promiseTracker, AlertService, CustomerService) {

	$scope.PHONE_REGEX = /^(\(?[0-9]+\)?[- ]?){3,4}$/;

	$scope.customer = {};
	$scope.tracker = promiseTracker();

	$scope.match = function(form) {
		form.$setValidity('matches', $scope.customer.password === $scope.customer.repeat);
	}

	$scope.doRegister = function() {
		var deferred = $scope.tracker.createPromise();
		CustomerService.register($scope.customer).then(function() {
			console.log('Success!');
		}, function() {
			AlertService.add('danger', 'An error occured while registering.');
		}).finally(deferred.resolve);
	}

	$scope.doLogin = function() {
		var deferred = $scope.tracker.createPromise();
		CustomerService.login($scope.customer).then(function(data) {
			$cookies.put('jwt', data.jwt);
			$state.go('base.home');
		}, function() {
			AlertService.add('danger', 'Invalid username / password combination.');
		}).finally(deferred.resolve);
	}

}]);

angular.module('shop.controller.pay', [])
.controller('PayController', [
'$scope',
'$cookies',
'$location',
'$state',
'$stateParams',
'promiseTracker',
'AlertService',
'OrderService',
function($scope, $cookies, $location, $state, $stateParams, promiseTracker, AlertService, OrderService) {

	$scope.tracker = promiseTracker();

	$scope.confirm = function() {
		var deferred = $scope.tracker.createPromise();
		OrderService.endPayFlow($stateParams.orderId, $location.search().PayerID).then(function() {
			AlertService.add('success', 'Thank you! Your payment has been confirmed!');
			$state.go('base.home');
		}).then(function() {
			AlertService.add('danger', 'An error occured while confirming your payment. Please try again.');
		}).finally(deferred.resolve);
	}

}]);

angular.module('shop.controller.review', [])
.controller('ReviewController', [
'$scope',
'$cookies',
'AlertService',
'ReallyService',
'CategoryService',
'OrderService',
function($scope, $cookies, AlertService, ReallyService, CategoryService, OrderService) {

	$scope.categories = [];

	CategoryService.findAll().then(function(data) {
		$scope.categories = data;

	}, function() {
		AlertService.add('danger', 'Unable to load accessory categories!');
	});

	$scope.pay = function() {
		ReallyService.prompt({
			head: 'Pay $25 deposit?',
			body: 'By clicking "Continue", you will be redirected to PayPal to confirm the payment.',
			yes: 'Continue'
		}, OrderService.beginPayFlow.bind(null, $scope.order.id)).result.then(function(data) {
			window.location.href = data.location;
		}, function() {
			AlertService.add('danger', 'An error occured in the payment process. Please try again.');
		});
	};

}]);

angular.module('shop.controller.ribbons', [])
.controller('RibbonsController', [
'$scope',
'$modal',
'$q',
'promiseTracker',
'AlertService',
'LetterService',
'RibbonService',
function($scope, $modal, $q, promiseTracker, AlertService, LetterService, RibbonService) {

	$scope.tracker = promiseTracker();
	$scope.letters = [];

	LetterService.findAll().then(function(data) {
		$scope.letters = data;
	}, function() {
		AlertService.add('danger', 'Unable to load letters.');
	});

	$scope.addRibbon = function() {
		var modal = $modal.open({
			size: 'medium',
			templateUrl: 'editRibbon.html',
			controller: 'EditRibbonController',
			resolve: {
				callback: function() {
					return function(ribbon) {
						return RibbonService.create(ribbon).then(function(data) {
							$scope.mum.ribbons.push(data);
						});
					};
				},
				saveMum: function() {
					return function() {
						return $scope.save($scope.mum);
					};
				},
				letters: function() {
					return $scope.letters;
				},
				ribbon: function() {
					return {
						mum: $scope.mum.id
					};
				}
			}
		});
	};

	$scope.editRibbon = function(ribbonIndex) {
		var modal = $modal.open({
			size: 'medium',
			templateUrl: 'editRibbon.html',
			controller: 'EditRibbonController',
			resolve: {
				callback: function() {
					return function(target) {
						return RibbonService.update(target.id, target).then(function(data) {
							$scope.mum.ribbons[ribbonIndex] = data;
						});
					};
				},
				saveMum: function() {
					return function() {
						return $scope.save($scope.mum);
					};
				},
				letters: function() {
					return $scope.letters;
				},
				ribbon: function() {
					var target = angular.copy($scope.mum.ribbons[ribbonIndex]);
					target.mum = $scope.mum.id;
					return target;
				}
			}
		});
	}

	$scope.deleteRibbon = function(index) {
		var ribbon = $scope.mum.ribbons[index];
		ribbon.tracker = promiseTracker();
		var deferred = ribbon.tracker.createPromise();
		RibbonService.delete(ribbon.id).then(function() {
			$scope.mum.ribbons.splice(index, 1);
		}, function() {
			AlertService.add('danger', 'Unable to delete name ribbon.');
		}).finally(deferred.resolve);
	};

}])
.controller('EditRibbonController', [
'$scope',
'$modalInstance',
'promiseTracker',
'AlertService',
'callback',
'saveMum',
'letters',
'ribbon',
function($scope, $modalInstance, promiseTracker, AlertService, callback, saveMum, letters, ribbon) {

	$scope.letters = letters;
	$scope.ribbon = ribbon;	
	$scope.tracker = promiseTracker();

	$scope.cancel = $modalInstance.dismiss;

	$scope.save = function() {
		var deferred = $scope.tracker.createPromise();
		var target = angular.copy($scope.ribbon);
		target.letter = target.letter.id;
		callback(target).then($modalInstance.close, function() {
			AlertService.add('danger', 'Unable to save name ribbon.');
			$modalInstance.dismiss();
		}).then(saveMum).finally(deferred.resolve);
	};

}]);
